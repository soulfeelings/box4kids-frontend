# 1.6 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ React Query

**‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 1 —á–∞—Å

## üéØ –¶–µ–ª—å

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å React Query –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö.

## üìã –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∏–µ QueryClient –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/utils/queryClient.ts`

```typescript
import { QueryClient, DefaultOptions } from "@tanstack/react-query";
import { ApiError } from "../types/errors";

const queryConfig: DefaultOptions = {
  queries: {
    // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞ (5 –º–∏–Ω—É—Ç)
    staleTime: 5 * 60 * 1000,

    // –í—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö (10 –º–∏–Ω—É—Ç)
    gcTime: 10 * 60 * 1000,

    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    retry: (failureCount, error) => {
      // –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (4xx)
      if (
        error instanceof ApiError &&
        error.status >= 400 &&
        error.status < 500
      ) {
        return false;
      }

      // –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –æ—à–∏–±–æ–∫
      return failureCount < 3;
    },

    // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),

    // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –æ–∫–Ω–∞
    refetchOnWindowFocus: false,

    // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    refetchOnReconnect: true,
  },
  mutations: {
    // –û–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –¥–ª—è –º—É—Ç–∞—Ü–∏–π
    retry: 1,

    // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –¥–ª—è –º—É—Ç–∞—Ü–∏–π
    retryDelay: 1000,
  },
};

export const queryClient = new QueryClient({
  defaultOptions: queryConfig,
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
queryClient.setMutationDefaults(["auth"], {
  mutationFn: async () => {
    throw new Error("Mutation not implemented");
  },
  onError: (error) => {
    console.error("Auth mutation error:", error);
  },
});
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ App.tsx

**–§–∞–π–ª:** `src/App.tsx`

```typescript
import React from "react";
import { QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { queryClient } from "./utils/queryClient";
import LoginPage from "./pages/LoginPage";
import "./App.css";

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <div className="App">
        <LoginPage />
      </div>

      {/* DevTools —Ç–æ–ª—å–∫–æ –≤ development */}
      {process.env.NODE_ENV === "development" && (
        <ReactQueryDevtools
          initialIsOpen={false}
          buttonPosition="bottom-left"
        />
      )}
    </QueryClientProvider>
  );
}

export default App;
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö query keys

**–§–∞–π–ª:** `src/utils/queryKeys.ts`

```typescript
// –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
export const queryKeys = {
  // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
  auth: {
    user: ["auth", "user"] as const,
    profile: (userId: number) => ["auth", "profile", userId] as const,
  },

  // –î–µ—Ç–∏
  children: {
    all: ["children"] as const,
    byParent: (parentId: number) => ["children", "parent", parentId] as const,
    detail: (childId: string) => ["children", "detail", childId] as const,
  },

  // –ü–æ–¥–ø–∏—Å–∫–∏
  subscriptions: {
    all: ["subscriptions"] as const,
    byUser: (userId: number) => ["subscriptions", "user", userId] as const,
    byChild: (childId: string) => ["subscriptions", "child", childId] as const,
  },
} as const;

// –¢–∏–ø—ã –¥–ª—è –∫–ª—é—á–µ–π
export type QueryKeys = typeof queryKeys;
```

### 4. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Ö—É–∫–æ–≤

**–§–∞–π–ª:** `src/hooks/api/useQueryHelpers.ts`

```typescript
import { useQueryClient } from "@tanstack/react-query";
import { queryKeys } from "../../utils/queryKeys";
import { User, Child } from "../../types/api";

export const useQueryHelpers = () => {
  const queryClient = useQueryClient();

  const invalidateQueries = {
    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    user: () => {
      queryClient.invalidateQueries({ queryKey: queryKeys.auth.user });
    },

    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–µ—Ç–µ–π
    children: (parentId?: number) => {
      if (parentId) {
        queryClient.invalidateQueries({
          queryKey: queryKeys.children.byParent(parentId),
        });
      } else {
        queryClient.invalidateQueries({ queryKey: queryKeys.children.all });
      }
    },

    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
    subscriptions: (userId?: number) => {
      if (userId) {
        queryClient.invalidateQueries({
          queryKey: queryKeys.subscriptions.byUser(userId),
        });
      } else {
        queryClient.invalidateQueries({
          queryKey: queryKeys.subscriptions.all,
        });
      }
    },
  };

  const updateCache = {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫—ç—à–µ
    user: (user: User) => {
      queryClient.setQueryData(queryKeys.auth.user, user);
      queryClient.setQueryData(queryKeys.auth.profile(user.id), user);
    },

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–±–µ–Ω–∫–∞ –≤ –∫—ç—à
    addChild: (parentId: number, child: Child) => {
      queryClient.setQueryData(
        queryKeys.children.byParent(parentId),
        (old: Child[] = []) => [...old, child]
      );
    },

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–±–µ–Ω–∫–∞ –≤ –∫—ç—à–µ
    updateChild: (parentId: number, updatedChild: Child) => {
      queryClient.setQueryData(
        queryKeys.children.byParent(parentId),
        (old: Child[] = []) =>
          old.map((child) =>
            child.id === updatedChild.id ? updatedChild : child
          )
      );
    },
  };

  return {
    invalidateQueries,
    updateCache,
    queryClient,
  };
};
```

### 5. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

**–§–∞–π–ª:** `src/components/QueryProvider.tsx`

```typescript
import React from "react";
import { QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { queryClient } from "../utils/queryClient";
import { ApiError } from "../types/errors";

interface QueryProviderProps {
  children: React.ReactNode;
}

export const QueryProvider: React.FC<QueryProviderProps> = ({ children }) => {
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
  React.useEffect(() => {
    const handleError = (error: Error) => {
      if (error instanceof ApiError) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö API –æ—à–∏–±–æ–∫
        switch (error.status) {
          case 401:
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            console.error("Unauthorized:", error.message);
            break;
          case 403:
            // –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
            console.error("Forbidden:", error.message);
            break;
          case 500:
            // –°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞
            console.error("Server error:", error.message);
            break;
          default:
            console.error("API error:", error.message);
        }
      } else {
        console.error("Unexpected error:", error);
      }
    };

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏
    queryClient.getQueryCache().subscribe((event) => {
      if (event.type === "error") {
        handleError(event.error as Error);
      }
    });

    queryClient.getMutationCache().subscribe((event) => {
      if (event.type === "error") {
        handleError(event.error as Error);
      }
    });
  }, []);

  return (
    <QueryClientProvider client={queryClient}>
      {children}

      {/* DevTools —Ç–æ–ª—å–∫–æ –≤ development */}
      {process.env.NODE_ENV === "development" && (
        <ReactQueryDevtools
          initialIsOpen={false}
          buttonPosition="bottom-left"
        />
      )}
    </QueryClientProvider>
  );
};
```

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/utils/__tests__/queryClient.test.ts`

```typescript
import { queryClient } from "../queryClient";

describe("QueryClient Configuration", () => {
  test("should have correct default options", () => {
    const defaultOptions = queryClient.getDefaultOptions();

    expect(defaultOptions.queries?.staleTime).toBe(5 * 60 * 1000);
    expect(defaultOptions.queries?.gcTime).toBe(10 * 60 * 1000);
    expect(defaultOptions.queries?.refetchOnWindowFocus).toBe(false);
    expect(defaultOptions.mutations?.retry).toBe(1);
  });
});
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] QueryClient –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏
- [ ] App.tsx –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è QueryClientProvider
- [ ] ReactQueryDevtools –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
- [ ] –ë–∞–∑–æ–≤—ã–µ query keys —Å–æ–∑–¥–∞–Ω—ã
- [ ] –•–µ–ª–ø–µ—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞

## üéõÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π

### Development

```typescript
const queryConfig: DefaultOptions = {
  queries: {
    staleTime: 0, // –î–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    retry: 1, // –ú–µ–Ω—å—à–µ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ª–∞–¥–∫–∏
  },
};
```

### Production

```typescript
const queryConfig: DefaultOptions = {
  queries: {
    staleTime: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    retry: 3, // –ë–æ–ª—å—à–µ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
  },
};
```

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —à–∞–≥–∏

- **–ü—Ä–µ–¥—ã–¥—É—â–∏–π:** [1.5 –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤](./1.5-base-services.md)
- **–°–ª–µ–¥—É—é—â–∏–π:** [–≠—Ç–∞–ø 2: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è](../2-authentication/)

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [React Query Documentation](https://tanstack.com/query/latest/docs/react/overview)
- [Best Practices](https://tkdodo.eu/blog/practical-react-query)
