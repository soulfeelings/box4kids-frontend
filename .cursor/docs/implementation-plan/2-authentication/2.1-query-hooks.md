# 2.1 –°–æ–∑–¥–∞–Ω–∏–µ React Query —Ö—É–∫–æ–≤

**‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 2 —á–∞—Å–∞

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ö—É–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ React Query.

## üìã –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ —Ö—É–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–§–∞–π–ª:** `src/hooks/api/useAuth.ts`

```typescript
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { authService } from "../../services/authService";
import { queryKeys } from "../../utils/queryKeys";
import { ApiError } from "../../types/errors";
import { User } from "../../types/api";

export const useAuth = () => {
  const queryClient = useQueryClient();

  const sendOtpMutation = useMutation({
    mutationFn: authService.sendOtp,
    onError: (error: ApiError) => {
      console.error("OTP Send Error:", error.message);
    },
  });

  const verifyOtpMutation = useMutation({
    mutationFn: ({ phone, code }: { phone: string; code: string }) =>
      authService.verifyOtp(phone, code),
    onSuccess: (user: User) => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      queryClient.setQueryData(queryKeys.auth.user, user);
      queryClient.setQueryData(queryKeys.auth.profile(user.id), user);
    },
    onError: (error: ApiError) => {
      console.error("OTP Verify Error:", error.message);
    },
  });

  const logoutMutation = useMutation({
    mutationFn: authService.logout,
    onSuccess: () => {
      // –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
      queryClient.clear();
    },
  });

  return {
    // –ú–µ—Ç–æ–¥—ã
    sendOtp: sendOtpMutation.mutate,
    sendOtpAsync: sendOtpMutation.mutateAsync,
    verifyOtp: verifyOtpMutation.mutate,
    verifyOtpAsync: verifyOtpMutation.mutateAsync,
    logout: logoutMutation.mutate,

    // –°–æ—Å—Ç–æ—è–Ω–∏—è
    isSendingOtp: sendOtpMutation.isPending,
    isVerifyingOtp: verifyOtpMutation.isPending,
    isLoggingOut: logoutMutation.isPending,
    isLoading: sendOtpMutation.isPending || verifyOtpMutation.isPending,

    // –û—à–∏–±–∫–∏
    sendOtpError: sendOtpMutation.error,
    verifyOtpError: verifyOtpMutation.error,
    logoutError: logoutMutation.error,
    error: sendOtpMutation.error || verifyOtpMutation.error,

    // –î–∞–Ω–Ω—ã–µ
    sendOtpData: sendOtpMutation.data,
    verifyOtpData: verifyOtpMutation.data,

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
    resetSendOtp: sendOtpMutation.reset,
    resetVerifyOtp: verifyOtpMutation.reset,
  };
};
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ö—É–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

**–§–∞–π–ª:** `src/hooks/api/useUser.ts`

```typescript
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { userService } from "../../services/userService";
import { queryKeys } from "../../utils/queryKeys";
import { User } from "../../types/api";
import { ProfileUpdateRequest } from "../../types/requests";

export const useUser = (userId?: number) => {
  const queryClient = useQueryClient();

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userQuery = useQuery({
    queryKey: queryKeys.auth.profile(userId!),
    queryFn: () => userService.getProfile(userId!),
    enabled: !!userId,
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
  const updateProfileMutation = useMutation({
    mutationFn: ({
      userId,
      data,
    }: {
      userId: number;
      data: ProfileUpdateRequest;
    }) => userService.updateProfile(userId, data),
    onSuccess: (updatedUser: User) => {
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
      queryClient.setQueryData(queryKeys.auth.user, updatedUser);
      queryClient.setQueryData(
        queryKeys.auth.profile(updatedUser.id),
        updatedUser
      );
    },
  });

  return {
    // –î–∞–Ω–Ω—ã–µ
    user: userQuery.data,

    // –°–æ—Å—Ç–æ—è–Ω–∏—è
    isLoading: userQuery.isLoading,
    isUpdating: updateProfileMutation.isPending,

    // –û—à–∏–±–∫–∏
    error: userQuery.error || updateProfileMutation.error,
    updateError: updateProfileMutation.error,

    // –ú–µ—Ç–æ–¥—ã
    updateProfile: updateProfileMutation.mutate,
    updateProfileAsync: updateProfileMutation.mutateAsync,

    // –£—Ç–∏–ª–∏—Ç—ã
    refetch: userQuery.refetch,
    reset: updateProfileMutation.reset,
  };
};
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ö—É–∫–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `src/hooks/api/useCurrentUser.ts`

```typescript
import { useQuery } from "@tanstack/react-query";
import { queryKeys } from "../../utils/queryKeys";
import { User } from "../../types/api";

export const useCurrentUser = () => {
  const userQuery = useQuery({
    queryKey: queryKeys.auth.user,
    queryFn: () => {
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
      const cached = JSON.parse(localStorage.getItem("current_user") || "null");
      return cached as User | null;
    },
    staleTime: Infinity, // –î–∞–Ω–Ω—ã–µ –Ω–µ —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç, –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –º—É—Ç–∞—Ü–∏—è—Ö
  });

  return {
    user: userQuery.data,
    isLoading: userQuery.isLoading,
    isAuthenticated: !!userQuery.data,
    error: userQuery.error,
    refetch: userQuery.refetch,
  };
};
```

### 4. –°–æ–∑–¥–∞–Ω–∏–µ compose —Ö—É–∫–∞

**–§–∞–π–ª:** `src/hooks/api/useAuthFlow.ts`

```typescript
import { useAuth } from "./useAuth";
import { useCurrentUser } from "./useCurrentUser";
import { useUser } from "./useUser";

export const useAuthFlow = () => {
  const auth = useAuth();
  const currentUser = useCurrentUser();
  const user = useUser(currentUser.user?.id);

  const handleSendOtp = async (phone: string) => {
    try {
      await auth.sendOtpAsync(phone);
      return { success: true };
    } catch (error) {
      return { success: false, error };
    }
  };

  const handleVerifyOtp = async (phone: string, code: string) => {
    try {
      const user = await auth.verifyOtpAsync({ phone, code });

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
      localStorage.setItem("current_user", JSON.stringify(user));

      return { success: true, user };
    } catch (error) {
      return { success: false, error };
    }
  };

  const handleUpdateProfile = async (data: { name: string }) => {
    if (!currentUser.user) {
      throw new Error("User not authenticated");
    }

    try {
      const updatedUser = await user.updateProfileAsync({
        userId: currentUser.user.id,
        data,
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º localStorage
      localStorage.setItem("current_user", JSON.stringify(updatedUser));

      return { success: true, user: updatedUser };
    } catch (error) {
      return { success: false, error };
    }
  };

  const handleLogout = () => {
    auth.logout();
    localStorage.removeItem("current_user");
  };

  return {
    // Data
    currentUser: currentUser.user,
    isAuthenticated: currentUser.isAuthenticated,

    // Loading states
    isLoading: auth.isLoading || currentUser.isLoading || user.isLoading,
    isSendingOtp: auth.isSendingOtp,
    isVerifyingOtp: auth.isVerifyingOtp,
    isUpdatingProfile: user.isUpdating,

    // Errors
    sendOtpError: auth.sendOtpError,
    verifyOtpError: auth.verifyOtpError,
    updateProfileError: user.updateError,

    // Methods
    sendOtp: handleSendOtp,
    verifyOtp: handleVerifyOtp,
    updateProfile: handleUpdateProfile,
    logout: handleLogout,

    // Reset methods
    resetSendOtp: auth.resetSendOtp,
    resetVerifyOtp: auth.resetVerifyOtp,
  };
};
```

### 5. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

**–§–∞–π–ª:** `src/hooks/api/index.ts`

```typescript
export { useAuth } from "./useAuth";
export { useUser } from "./useUser";
export { useCurrentUser } from "./useCurrentUser";
export { useAuthFlow } from "./useAuthFlow";
export { useQueryHelpers } from "./useQueryHelpers";
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [ ] –•—É–∫ `useAuth` —Å–æ–∑–¥–∞–Ω —Å –º—É—Ç–∞—Ü–∏—è–º–∏ –¥–ª—è OTP
- [ ] –•—É–∫ `useUser` —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª–µ–º
- [ ] –•—É–∫ `useCurrentUser` —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] Compose —Ö—É–∫ `useAuthFlow` —Å–æ–∑–¥–∞–Ω –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
- [ ] –í—Å–µ —Ö—É–∫–∏ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- [ ] –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ò–Ω–¥–µ–∫—Å–Ω—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω

## üí° –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∑–∞–≥—Ä—É–∑–∫–∏

```typescript
const isLoading = auth.isLoading || currentUser.isLoading || user.isLoading;
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞

```typescript
onSuccess: (user: User) => {
  queryClient.setQueryData(queryKeys.auth.user, user);
  queryClient.setQueryData(queryKeys.auth.profile(user.id), user);
},
```

### –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ localStorage

```typescript
localStorage.setItem("current_user", JSON.stringify(user));
```

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —à–∞–≥–∏

- **–ü—Ä–µ–¥—ã–¥—É—â–∏–π:** [1.6 –ù–∞—Å—Ç—Ä–æ–π–∫–∞ React Query](../1-infrastructure/1.6-react-query-setup.md)
- **–°–ª–µ–¥—É—é—â–∏–π:** [2.2 –ó–∞–º–µ–Ω–∞ handleSendCode](./2.2-send-otp.md)
